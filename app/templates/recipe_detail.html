<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>RecipeApp - –î–µ—Ç–∞–ª–∏ —Ä–µ—Ü–µ–ø—Ç–∞</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">üç≥ RecipeApp</div>
            <div class="nav-links">
                <a href="/">–í—Å–µ —Ä–µ—Ü–µ–ø—Ç—ã</a>
                <a href="/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="recipe-detail" id="recipeContainer">
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Ä–µ—Ü–µ–ø—Ç–∞ -->
            <div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ü–µ–ø—Ç–∞...</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–∑—ã–≤–∞ -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReviewModal()">&times;</span>
            <h3>–í–∞—à –æ—Ç–∑—ã–≤</h3>
            <form id="reviewForm" onsubmit="submitReview(event)">
                <div class="form-group">
                    <label>–û—Ü–µ–Ω–∫–∞ (1-5):</label>
                    <input type="number" id="rating" min="1" max="5" required>
                </div>
                <div class="form-group">
                    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                    <textarea id="text" rows="4" required></textarea>
                </div>
                <button type="submit" class="submit-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const recipeId = window.location.pathname.split('/').pop();
            await loadRecipe(recipeId);
            await loadReviews(recipeId);
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Ü–µ–ø—Ç–∞
        async function loadRecipe(recipeId) {
            try {
                const response = await fetch(`/api/recipe/${recipeId}`);
                if (!response.ok) throw new Error('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                const recipe = await response.json();
                renderRecipe(recipe);
            } catch (error) {
                document.getElementById('recipeContainer').innerHTML = `
                    <div class="error-message">
                        ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Ü–µ–ø—Ç–∞: ${error.message}
                    </div>
                `;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ä–µ—Ü–µ–ø—Ç–∞
        function renderRecipe(recipe) {
            const container = document.getElementById('recipeContainer');
            container.innerHTML = `
                <h1 class="recipe-title">${recipe.title}</h1>

                <div class="recipe-header">
                    <img src="${recipe.image_url || '/static/default-recipe.jpg'}"
                         alt="${recipe.title}"
                         class="recipe-main-image">

                    <div class="recipe-info">
                        <div class="info-block">
                            <span class="info-label">‚è± –í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:</span>
                            <span class="info-value">${recipe.cooking_time} –º–∏–Ω</span>
                        </div>
                        <div class="info-block">
                            <span class="info-label">‚≠ê –†–µ–π—Ç–∏–Ω–≥:</span>
                            <span class="info-value">${recipe.average_rating?.toFixed(1) || '–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫'}</span>
                        </div>
                        <div class="info-block">
                            <span class="info-label">üçΩ –ö—É—Ö–Ω—è:</span>
                            <span class="info-value">${recipe.cuisine || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                        </div>
                    </div>
                </div>

                <div class="recipe-section">
                    <h2>–û–ø–∏—Å–∞–Ω–∏–µ</h2>
                    <div class="description">
                        ${recipe.description || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}
                    </div>
                </div>

                ${recipe.giga_chat_description ? `
                <div class="recipe-section">
                    <h2>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ GigaChat</h2>
                    <div class="giga-chat">
                        ${recipe.giga_chat_description}
                    </div>
                </div>` : ''}

                <!-- –ë–ª–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ –ü–û–î –û–ü–ò–°–ê–ù–ò–ï–ú -->
                <div class="reviews-section">
                    <h2>–û—Ç–∑—ã–≤—ã</h2>
                    <button class="add-review-btn" onclick="showReviewModal()">‚úèÔ∏è –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                    <div class="reviews-container" id="reviewsContainer"></div>
                </div>
            `;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ç–∑—ã–≤–∞–º–∏
        async function loadReviews(recipeId) {
            try {
                const response = await fetch(`/api/reviews/${recipeId}`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤');
                const reviews = await response.json();
                renderReviews(reviews);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        function renderReviews(reviews) {
            const container = document.getElementById('reviewsContainer');
            container.innerHTML = reviews.map(review => `
                <div class="review-card">
                    <div class="review-header">
                        <span class="user-id">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${review.user_id}</span>
                        <span class="review-rating">‚≠ê ${review.rating}</span>
                    </div>
                    <div class="review-comment">${review.text}</div>
                    <div class="review-date">${new Date(review.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function showReviewModal() {
            document.getElementById('reviewModal').style.display = 'block';
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
        }

        async function submitReview(event) {
            event.preventDefault();
            const recipeId = window.location.pathname.split('/').pop();
            const reviewData = {
                rating: parseInt(document.getElementById('rating').value),
                text: document.getElementById('text').value
            };

            try {
                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –∑–∞–ø—Ä–æ—Å–∞
                const response = await fetch(`/api/addreview?recipe_id=${recipe_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(reviewData)
                });

                if (response.redirected) {
                    window.location.href = response.url; // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ –ª–æ–≥–∏–Ω
                    return;
                }

                if (response.ok) {
                    closeReviewModal();
                    await loadReviews(recipeId);
                    document.getElementById('reviewForm').reset();
                } else {
                    const errorData = await response.json();
                    alert(`–û—à–∏–±–∫–∞: ${errorData.detail}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }
    </script>
</body>
</html>